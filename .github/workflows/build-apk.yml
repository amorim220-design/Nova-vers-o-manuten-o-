name: Build Android APK (Capacitor Signed)

on:
  push:
    branches: [ "main", "master" ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Node
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Install dependencies
        run: npm install

      - name: Build web (Vite)
        run: npm run build

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: "17"

      # ðŸ”¹ LÃª version.json (SEM ERRO DE SINTAXE)
      - name: Read version.json
        run: |
          VERSION_CODE=$(node -p "require('./version.json').versionCode")
          VERSION_NAME=$(node -p "require('./version.json').version")

          if [ -z "$VERSION_CODE" ] || [ -z "$VERSION_NAME" ]; then
            echo "version.json precisa ter version e versionCode"
            exit 1
          fi

          echo "VERSION_CODE=$VERSION_CODE" >> $GITHUB_ENV
          echo "VERSION_NAME=$VERSION_NAME" >> $GITHUB_ENV

          echo "Version OK: $VERSION_NAME ($VERSION_CODE)"

      # ðŸ”¹ SEMPRE recria o Android do zero
      - name: Recreate Android platform
        run: |
          rm -rf android
          npx cap add android

      - name: Sync Capacitor
        run: npx cap sync android

      # ðŸ”¹ Decodifica keystore
      - name: Decode keystore
        run: |
          echo "${{ secrets.ANDROID_KEYSTORE_BASE64 }}" | base64 -d > android/app/release.keystore

      # ðŸ”¹ Cria keystore.properties
      - name: Create keystore.properties
        run: |
          cat > android/keystore.properties <<EOF
          storeFile=app/release.keystore
          storePassword=${{ secrets.ANDROID_KEYSTORE_PASSWORD }}
          keyAlias=${{ secrets.ANDROID_KEY_ALIAS }}
          keyPassword=${{ secrets.ANDROID_KEY_PASSWORD }}
          EOF

      # ðŸ”¹ Build APK RELEASE assinado
      - name: Build RELEASE APK
        run: |
          cd android
          chmod +x gradlew
          ./gradlew assembleRelease \
            -PVERSION_CODE=$VERSION_CODE \
            -PVERSION_NAME=$VERSION_NAME

      # ðŸ”¹ Localiza APK assinado
      - name: Find APK
        run: |
          APK_PATH=$(find android/app/build/outputs/apk/release -name "*.apk" ! -name "*unsigned*" | head -n 1)

          if [ -z "$APK_PATH" ]; then
            echo "APK assinado nÃ£o encontrado"
            exit 1
          fi

          echo "APK_PATH=$APK_PATH" >> $GITHUB_ENV
          echo "APK encontrado: $APK_PATH"

      # ðŸ”¹ Renomeia APK
      - name: Rename APK
        run: |
          mv "$APK_PATH" manutencao-apartamentos-v$VERSION_NAME.apk

      # ðŸ”¹ Upload do APK
      - name: Upload APK
        uses: actions/upload-artifact@v4
        with:
          name: apk-release
          path: manutencao-apartamentos-v*.apk
