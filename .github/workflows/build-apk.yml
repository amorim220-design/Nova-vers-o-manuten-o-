name: Build Android APK (SIGNED Release)

on:
  push:
    branches: [ "main", "master" ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    defaults:
      run:
        shell: bash

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Node 20
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Install dependencies
        run: |
          if [ -f package-lock.json ]; then
            npm ci
          else
            npm install
          fi

      # Descobre a MAJOR do Capacitor Core (ex: 6)
      - name: Detect Capacitor major
        run: |
          CORE_MAJOR=$(node -p "require('@capacitor/core/package.json').version.split('.')[0]")
          echo "CORE_MAJOR=$CORE_MAJOR" >> $GITHUB_ENV
          echo "Capacitor core major: $CORE_MAJOR"

      # Instala plugins na mesma major do core (evita ERESOLVE)
      - name: Ensure required Capacitor plugins (matching major)
        run: |
          npm i @capacitor/app@^${CORE_MAJOR}.0.0 @capacitor/browser@^${CORE_MAJOR}.0.0
          npm i -D @capacitor/assets

      - name: Build web (Vite)
        run: npm run build

      - name: Verify webDir exists
        run: |
          # Ajuste aqui se seu webDir NÃO for dist
          if [ ! -d "dist" ]; then
            echo "Pasta dist não existe. Verifique o build/webDir."
            ls -la
            exit 1
          fi
          if [ ! -f "dist/index.html" ]; then
            echo "dist/index.html não encontrado."
            ls -la dist || true
            exit 1
          fi

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: "17"

      - name: Read version.json
        run: |
          VERSION_CODE=$(node -p "require('./version.json').versionCode")
          VERSION_NAME=$(node -p "require('./version.json').version")

          if [ -z "$VERSION_CODE" ] || [ -z "$VERSION_NAME" ]; then
            echo "version.json precisa ter version e versionCode"
            exit 1
          fi

          echo "VERSION_CODE=$VERSION_CODE" >> $GITHUB_ENV
          echo "VERSION_NAME=$VERSION_NAME" >> $GITHUB_ENV
          echo "Version OK: $VERSION_NAME ($VERSION_CODE)"

      - name: Recreate Android platform
        run: |
          rm -rf android
          npx cap add android

      - name: Sync Capacitor (web -> android)
        run: npx cap sync android

      # ✅ ÍCONES / SPLASH: comando correto
      # Espera "resources/" ou "assets/" na raiz. Ex: resources/icon.png (1024x1024)
      - name: Generate Android icons/splash (Capacitor Assets)
        run: |
          ls -la resources || true
          npx @capacitor/assets generate --android --assetPath resources

      - name: Sync again (after assets)
        run: npx cap sync android

      - name: Decode keystore (Node safe)
        env:
          KS: ${{ secrets.ANDROID_KEYSTORE_BASE64 }}
        run: |
          node -e "const fs=require('fs'); const b=process.env.KS||''; if(!b){console.error('ANDROID_KEYSTORE_BASE64 vazio'); process.exit(1);} fs.mkdirSync('android/app',{recursive:true}); fs.writeFileSync('android/app/release.jks', Buffer.from(b,'base64')); console.log('Keystore OK:', fs.statSync('android/app/release.jks').size, 'bytes');"

      - name: Verify keystore (list aliases)
        run: |
          keytool -list -v \
            -keystore android/app/release.jks \
            -storepass "${{ secrets.ANDROID_KEYSTORE_PASSWORD }}" \
            | sed -n '1,140p'

      - name: Patch Gradle signing config
        run: |
          APP_GRADLE="android/app/build.gradle"

          perl -0777 -i -pe 's/signingConfigs\s*\{.*?\}\s*//gs' "$APP_GRADLE"
          perl -0777 -i -pe 's/buildTypes\s*\{\s*release\s*\{(.*?)\}\s*\}/buildTypes {\n        release {\1\n            signingConfig signingConfigs.release\n        }\n    }/gs' "$APP_GRADLE"
          perl -0777 -i -pe 's/android\s*\{\s*/android {\n    signingConfigs {\n        release {\n            storeFile file(\"release.jks\")\n            storePassword System.getenv(\"ANDROID_KEYSTORE_PASSWORD\")\n            keyAlias System.getenv(\"ANDROID_KEY_ALIAS\")\n            keyPassword System.getenv(\"ANDROID_KEY_PASSWORD\")\n        }\n    }\n\n/gs' "$APP_GRADLE"

      - name: Build RELEASE APK (signed)
        run: |
          cd android
          chmod +x gradlew
          ./gradlew assembleRelease -x test \
            -PVERSION_CODE=$VERSION_CODE \
            -PVERSION_NAME=$VERSION_NAME
        env:
          ANDROID_KEYSTORE_PASSWORD: ${{ secrets.ANDROID_KEYSTORE_PASSWORD }}
          ANDROID_KEY_ALIAS: ${{ secrets.ANDROID_KEY_ALIAS }}
          ANDROID_KEY_PASSWORD: ${{ secrets.ANDROID_KEY_PASSWORD }}

      - name: Find APK
        run: |
          APK_SIGNED=$(find android/app/build/outputs/apk/release -name "*.apk" ! -name "*unsigned*" | head -n 1)
          if [ -z "$APK_SIGNED" ]; then
            echo "APK assinado não encontrado. Listando arquivos:"
            find android/app/build/outputs/apk -name "*.apk" -print || true
            exit 1
          fi
          echo "APK_PATH=$APK_SIGNED" >> $GITHUB_ENV
          echo "APK assinado: $APK_SIGNED"

      - name: Rename APK
        run: |
          mv "$APK_PATH" "manutencao-apartamentos-v$VERSION_NAME.apk"

      - name: Upload APK
        uses: actions/upload-artifact@v4
        with:
          name: apk-release
          path: manutencao-apartamentos-v*.apk
