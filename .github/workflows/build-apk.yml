name: Build Android APK (SIGNED Release)

on:
  push:
    branches: [ "main", "master" ]
  workflow_dispatch:

concurrency:
  group: build-android-apk-${{ github.ref }}
  cancel-in-progress: true

jobs:
  build:
    runs-on: ubuntu-latest
    defaults:
      run:
        shell: bash

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node 20
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"

      - name: Install dependencies
        run: |
          if [ -f package-lock.json ]; then
            npm ci
          else
            npm install
          fi

      - name: Read version.json
        run: |
          node -e "const v=require('./version.json'); if(!v.version||!v.versionCode){console.error('version.json precisa ter version e versionCode'); process.exit(1)}; console.log('Version OK:', v.version, '('+v.versionCode+')')"
          echo "VERSION_CODE=$(node -p "require('./version.json').versionCode")" >> $GITHUB_ENV
          echo "VERSION_NAME=$(node -p "require('./version.json').version")" >> $GITHUB_ENV

      - name: Build web (Vite)
        run: npm run build
        env:
          VITE_FIREBASE_API_KEY: ${{ secrets.VITE_FIREBASE_API_KEY }}

      - name: Verify dist exists
        run: |
          ls -la
          ls -la dist || true
          test -f dist/index.html || (echo "dist/index.html não existe. Build falhou." && exit 1)

      - name: Setup JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: "17"

      # ✅ Recria Android do zero
      - name: Recreate Android platform
        run: |
          rm -rf android
          npx cap add android

      - name: Sync Capacitor (webDir -> android)
        run: npx cap sync android

      # ✅ ÍCONE/SPLASH automático (CORRETO)
      # Requer resources/icon.png (1024x1024) e opcional resources/splash.png (2732x2732)
      - name: Generate App Icons (Capacitor Assets)
        run: |
          npm i -D @capacitor/assets
          npx capacitor-assets generate --android
          echo "Assets generated."

      - name: Decode keystore
        env:
          KS: ${{ secrets.ANDROID_KEYSTORE_BASE64 }}
        run: |
          node -e "const fs=require('fs'); const b=process.env.KS||''; if(!b){console.error('ANDROID_KEYSTORE_BASE64 vazio'); process.exit(1);} fs.mkdirSync('android/app',{recursive:true}); fs.writeFileSync('android/app/release.jks', Buffer.from(b,'base64')); console.log('Keystore OK:', fs.statSync('android/app/release.jks').size, 'bytes');"

      - name: Verify keystore (list aliases)
        run: |
          keytool -list -v \
            -keystore android/app/release.jks \
            -storepass "${{ secrets.ANDROID_KEYSTORE_PASSWORD }}" \
            | sed -n '1,140p'

      # ✅ Patch signing sempre (porque você recria android/)
      - name: Patch Gradle signing config
        run: |
          APP_GRADLE="android/app/build.gradle"

          # Remove blocos signingConfigs antigos para evitar duplicação
          perl -0777 -i -pe 's/signingConfigs\s*\{.*?\}\s*//gs' "$APP_GRADLE"

          # Garante buildTypes.release -> signingConfig signingConfigs.release
          perl -0777 -i -pe 's/buildTypes\s*\{\s*release\s*\{(.*?)\}\s*\}/buildTypes {\n        release {\1\n            signingConfig signingConfigs.release\n        }\n    }/gs' "$APP_GRADLE"

          # Insere signingConfigs dentro do android { ... }
          perl -0777 -i -pe 's/android\s*\{\s*/android {\n    signingConfigs {\n        release {\n            storeFile file(\"release.jks\")\n            storePassword System.getenv(\"ANDROID_KEYSTORE_PASSWORD\")\n            keyAlias System.getenv(\"ANDROID_KEY_ALIAS\")\n            keyPassword System.getenv(\"ANDROID_KEY_PASSWORD\")\n        }\n    }\n\n/gs' "$APP_GRADLE"

      - name: Build RELEASE APK (signed)
        env:
          ANDROID_KEYSTORE_PASSWORD: ${{ secrets.ANDROID_KEYSTORE_PASSWORD }}
          ANDROID_KEY_ALIAS: ${{ secrets.ANDROID_KEY_ALIAS }}
          ANDROID_KEY_PASSWORD: ${{ secrets.ANDROID_KEY_PASSWORD }}
        run: |
          cd android
          chmod +x gradlew
          ./gradlew assembleRelease -x test \
            -PVERSION_CODE=$VERSION_CODE \
            -PVERSION_NAME=$VERSION_NAME

      - name: List APK outputs
        run: |
          echo "==== APK files ===="
          find android/app/build/outputs/apk -name "*.apk" -print || true

      - name: Pick APK
        run: |
          APK_SIGNED=$(find android/app/build/outputs/apk/release -name "*.apk" ! -name "*unsigned*" | head -n 1)
          APK_ANY=$(find android/app/build/outputs/apk/release -name "*.apk" | head -n 1)

          if [ -n "$APK_SIGNED" ]; then
            echo "APK signed: $APK_SIGNED"
            echo "APK_PATH=$APK_SIGNED" >> $GITHUB_ENV
          elif [ -n "$APK_ANY" ]; then
            echo "APK (fallback): $APK_ANY"
            echo "APK_PATH=$APK_ANY" >> $GITHUB_ENV
          else
            echo "Nenhum APK foi gerado."
            exit 1
          fi

      - name: Rename APK
        run: |
          mv "$APK_PATH" "manutencao-apartamentos-v$VERSION_NAME.apk"

      - name: Upload APK
        uses: actions/upload-artifact@v4
        with:
          name: apk-release
          path: manutencao-apartamentos-v*.apk
